-- Services
local HttpService     = game:GetService("HttpService")
local Players         = game:GetService("Players")
local UIS             = game:GetService("UserInputService")
local StarterGui      = game:GetService("StarterGui")

-- Config file (optional autosave)
local SaveFile = "script_config.json"
local function saveData(d) pcall(function() writefile(SaveFile, HttpService:JSONEncode(d)) end) end
local function loadData() 
    if isfile(SaveFile) then
        local ok, res = pcall(function() return HttpService:JSONDecode(readfile(SaveFile)) end)
        if ok then return res end
    end
    return {}
end

local config      = loadData()
local espEnabled  = config.esp or false
local autoSave    = config.autoSave ~= false

-- Main GUI (hidden until correct key)
local gui = Instance.new("ScreenGui")
gui.Name = "ScriptHub"
gui.ResetOnSpawn = false
gui.Enabled = false
gui.Parent = game.CoreGui

-- KeySystem GUI
local keyGui = Instance.new("ScreenGui")
keyGui.Name = "KeySystem"
keyGui.Parent = game.CoreGui

local bg = Instance.new("Frame", keyGui)
bg.Size = UDim2.new(0, 300, 0, 180)
bg.Position = UDim2.new(0.5, -150, 0.5, -90)
bg.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
bg.Active = true
bg.Draggable = true
Instance.new("UICorner", bg).CornerRadius = UDim.new(0, 10)

local title = Instance.new("TextLabel", bg)
title.Text = "üîê Nh·∫≠p Key ƒë·ªÉ ti·∫øp t·ª•c"
title.Size = UDim2.new(1, 0, 0, 35)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.new(1, 1, 1)
title.Font = Enum.Font.GothamBold
title.TextSize = 16

local input = Instance.new("TextBox", bg)
input.PlaceholderText = ""
input.Text = "Nh·∫≠p key ·ªü ƒë√¢y..."
input.Size = UDim2.new(1, -40, 0, 35)
input.Position = UDim2.new(0, 20, 0, 45)
input.Font = Enum.Font.Gotham
input.TextSize = 14
input.TextColor3 = Color3.new(1, 1, 1)
input.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
input.ClearTextOnFocus = false
Instance.new("UICorner", input).CornerRadius = UDim.new(0, 6)

-- Auto-clear/reset
input.Focused:Connect(function()
    if input.Text == "Nh·∫≠p key ·ªü ƒë√¢y..." then
        input.Text = ""
    end
end)
input.FocusLost:Connect(function()
    if input.Text == "" then
        input.Text = "Nh·∫≠p key ·ªü ƒë√¢y..."
    end
end)

-- Unlock Button
local btn = Instance.new("TextButton", bg)
btn.Text = "üîì ƒêang kho√°"
btn.Size = UDim2.new(1, -40, 0, 30)
btn.Position = UDim2.new(0, 20, 0, 90)
btn.Font = Enum.Font.GothamBold
btn.TextSize = 14
btn.TextColor3 = Color3.new(1, 1, 1)
btn.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)

-- Get Key Button
local getKeyBtn = Instance.new("TextButton", bg)
getKeyBtn.Text = "üîó L·∫•y Key"
getKeyBtn.Size = UDim2.new(1, -40, 0, 30)
getKeyBtn.Position = UDim2.new(0, 20, 0, 130)
getKeyBtn.Font = Enum.Font.GothamBold
getKeyBtn.TextSize = 14
getKeyBtn.TextColor3 = Color3.new(1, 1, 1)
getKeyBtn.BackgroundColor3 = Color3.fromRGB(0, 85, 170)
Instance.new("UICorner", getKeyBtn).CornerRadius = UDim.new(0, 6)

getKeyBtn.MouseButton1Click:Connect(function()
    setclipboard("https://pastefy.app/gkWLMCkb")
    StarterGui:SetCore("SendNotification", {
        Title = "üîó Link ƒë√£ ƒë∆∞·ª£c sao ch√©p",
        Text = "D√°n v√†o tr√¨nh duy·ªát ƒë·ªÉ l·∫•y key!",
        Duration = 5
    })
end)

local requiredKey = "TEST_KEY"  -- change to your actual key

btn.MouseButton1Click:Connect(function()
    if input.Text == requiredKey then
        keyGui:Destroy()
        gui.Enabled = true
        StarterGui:SetCore("SendNotification", {
            Title = "‚úÖ ƒê√∫ng Key!",
            Text = "Ch√†o m·ª´ng b·∫°n!",
            Duration = 5
        })
    else
        btn.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
        btn.Text = "‚ùå Sai Key"
        wait(1.2)
        btn.Text = "üîì M·ªü Kho√°"
        btn.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
    end
end)

-- GUI Toggle Button & frame (unchanged)
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0, 80, 0, 30)
toggleButton.Position = UDim2.new(0, 10, 0, 10)
toggleButton.BackgroundColor3 = Color3.fromRGB(50,50,50)
toggleButton.TextColor3 = Color3.new(1,1,1)
toggleButton.Font = Enum.Font.Gotham
toggleButton.TextSize = 14
toggleButton.Parent = gui

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 240, 0, 300)
frame.Position = UDim2.new(0.5, -120, 0.5, -150)
frame.BackgroundColor3 = Color3.fromRGB(40,40,40)
frame.Active = true
frame.Draggable = true
frame.Visible = false

local title = Instance.new("TextLabel")
title.Text = "Script nh√† l√†m"
title.Size = UDim2.new(1, 0, 0, 35)
title.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.GothamBold
title.TextSize = 18
title.Parent = frame

local tabBar = Instance.new("Frame")
tabBar.Size = UDim2.new(1, 0, 0, 30)
tabBar.Position = UDim2.new(0, 0, 0, 35)
tabBar.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
tabBar.Parent = frame

local tabLayout = Instance.new("UIListLayout", tabBar)
tabLayout.FillDirection = Enum.FillDirection.Horizontal
tabLayout.SortOrder = Enum.SortOrder.LayoutOrder
tabLayout.Padding = UDim.new(0, 2)

local tabs, pages = {}, {}

local function createTab(name)
    local tab = Instance.new("TextButton")
    tab.Text = name
    tab.Size = UDim2.new(1/3, -2, 1, 0)
    tab.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    tab.TextColor3 = Color3.fromRGB(255, 255, 255)
    tab.Font = Enum.Font.Gotham
    tab.TextSize = 14
    tab.Parent = tabBar
    tabs[name] = tab

    local page = Instance.new("Frame")
    page.Name = name .. "Page"
    page.Size = UDim2.new(1, 0, 1, -65)
    page.Position = UDim2.new(0, 0, 0, 65)
    page.BackgroundTransparency = 1
    page.Visible = false
    page.Parent = frame
    pages[name] = page

    local layout = Instance.new("UIListLayout", page)
    layout.Padding = UDim.new(0, 5)
    layout.FillDirection = Enum.FillDirection.Vertical
    layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    layout.SortOrder = Enum.SortOrder.LayoutOrder

    tab.MouseButton1Click:Connect(function()
        for _, p in pairs(pages) do p.Visible = false end
        page.Visible = true
    end)

    return page
end

local function createScriptButton(parent, name, callback)
    local button = Instance.new("TextButton")
    button.Text = name
    button.Size = UDim2.new(0.95, 0, 0, 35)
    button.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.Font = Enum.Font.Gotham
    button.TextSize = 14
    button.Parent = parent
    button.MouseButton1Click:Connect(callback)
end

local function createToggle(parent, name, default, callback)
    local holder = Instance.new("Frame")
    holder.Size = UDim2.new(0.95, 0, 0, 35)
    holder.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    holder.BorderSizePixel = 0
    holder.Parent = parent

    local label = Instance.new("TextLabel")
    label.Text = name
    label.Size = UDim2.new(0.6, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.Font = Enum.Font.Gotham
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = holder

    local toggle = Instance.new("TextButton")
    toggle.Size = UDim2.new(0, 40, 0, 20)
    toggle.Position = UDim2.new(1, -50, 0.5, -10)
    toggle.BackgroundColor3 = default and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(80, 80, 80)
    toggle.BorderSizePixel = 0
    toggle.Text = ""
    toggle.Parent = holder

    local circle = Instance.new("Frame")
    circle.Size = UDim2.new(0, 16, 0, 16)
    circle.Position = default and UDim2.new(0, 22, 0.5, -8) or UDim2.new(0, 2, 0.5, -8)
    circle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    circle.BorderSizePixel = 0
    circle.Parent = toggle

    Instance.new("UICorner", toggle).CornerRadius = UDim.new(1, 0)
    Instance.new("UICorner", circle).CornerRadius = UDim.new(1, 0)

    local state = default
    local function update()
        toggle.BackgroundColor3 = state and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(80, 80, 80)
        circle:TweenPosition(state and UDim2.new(0, 22, 0.5, -8) or UDim2.new(0, 2, 0.5, -8), "Out", "Quad", 0.2, true)
        if callback then callback(state) end
    end

    toggle.MouseButton1Click:Connect(function()
        state = not state
        update()
    end)

    update()
end

-- Esp
local espConnections = {}

local function removeESP(player)
    if player.Character then
        local head = player.Character:FindFirstChild("Head")
        if head then local gui = head:FindFirstChild("ESP_Name") if gui then gui:Destroy() end end
        local root = player.Character:FindFirstChild("HumanoidRootPart")
        if root then local box = root:FindFirstChild("ESP_Box") if box then box:Destroy() end end
    end
end

local function createESP(player)
    if player == game.Players.LocalPlayer then return end
    local function onCharacterAdded(character)
        if not espEnabled then return end
        local head = character:WaitForChild("Head", 10)
        local rootPart = character:WaitForChild("HumanoidRootPart", 10)
        if head then
            local billboard = Instance.new("BillboardGui")
            billboard.Name = "ESP_Name"
            billboard.Adornee = head
            billboard.Size = UDim2.new(0, 200, 0, 50)
            billboard.StudsOffset = Vector3.new(0, 2, 0)
            billboard.AlwaysOnTop = true
            local nameLabel = Instance.new("TextLabel")
            nameLabel.Size = UDim2.new(1, 0, 1, 0)
            nameLabel.BackgroundTransparency = 1
            nameLabel.Text = player.Name
            nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
            nameLabel.TextStrokeTransparency = 0.5
            nameLabel.TextScaled = true
            nameLabel.Parent = billboard
            billboard.Parent = head
        end
        if rootPart then
            local box = Instance.new("BoxHandleAdornment")
            box.Name = "ESP_Box"
            box.Adornee = rootPart
            box.Size = Vector3.new(4, 6, 2)
            box.AlwaysOnTop = true
            box.ZIndex = 0
            box.Transparency = 0.7
            box.Color3 = Color3.new(1, 0, 0)
            box.Parent = rootPart
        end
    end
    if player.Character then onCharacterAdded(player.Character) end
    table.insert(espConnections, player.CharacterAdded:Connect(onCharacterAdded))
end

local function enableESP()
    for _, p in ipairs(game.Players:GetPlayers()) do createESP(p) end
    table.insert(espConnections, game.Players.PlayerAdded:Connect(createESP))
end

local function disableESP()
    for _, p in ipairs(game.Players:GetPlayers()) do removeESP(p) end
    for _, conn in ipairs(espConnections) do conn:Disconnect() end
    espConnections = {}
end

-- === PAGES ===
local mainPage = createTab("Main")
local miscPage = createTab("Misc")
local settingsPage = createTab("Settings")
pages["Main"].Visible = true

-- === Main Toggle
-- Speed
local speedRow = Instance.new("Frame", mainPage)
speedRow.Size = UDim2.new(0.95, 0, 0, 35)
speedRow.Position = UDim2.new(0.025, 0, 0, 45) -- adjust Y as needed
speedRow.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
speedRow.BorderSizePixel = 0

local rowCorner = Instance.new("UICorner", speedRow)
rowCorner.CornerRadius = UDim.new(0, 6)

local speedLabel = Instance.new("TextLabel", speedRow)
speedLabel.Text = "T·ªëc ƒë·ªô ch·∫°y"
speedLabel.Size = UDim2.new(0.5, 0, 1, 0)
speedLabel.Position = UDim2.new(0.05, 0, 0, 0)
speedLabel.BackgroundTransparency = 1
speedLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
speedLabel.Font = Enum.Font.Gotham
speedLabel.TextSize = 14
speedLabel.TextXAlignment = Enum.TextXAlignment.Left

local speedInput = Instance.new("TextBox", speedRow)
speedInput.Size = UDim2.new(0.4, 0, 0.7, 0)
speedInput.Position = UDim2.new(0.55, 0, 0.15, 0)
speedInput.PlaceholderText = "16"
speedInput.Text = tostring(Players.LocalPlayer.Character and Players.LocalPlayer.Character:FindFirstChildOfClass("Humanoid") and Players.LocalPlayer.Character:FindFirstChildOfClass("Humanoid").WalkSpeed or 16)
speedInput.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
speedInput.TextColor3 = Color3.fromRGB(255, 255, 255)
speedInput.Font = Enum.Font.Gotham
speedInput.TextSize = 14
speedInput.ClearTextOnFocus = false

local speedCorner = Instance.new("UICorner", speedInput)
speedCorner.CornerRadius = UDim.new(0, 6)

speedInput.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        local speed = tonumber(speedInput.Text)
        if speed then
            local humanoid = Players.LocalPlayer.Character and Players.LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = speed
                StarterGui:SetCore("SendNotification", {
                    Title = "‚úÖ ƒê√£ ƒë·ªïi t·ªëc ƒë·ªô ch·∫°y",
                    Text = "T·ªëc ƒë·ªô m·ªõi: " .. speed,
                    Duration = 4
                })
            end
        else
            StarterGui:SetCore("SendNotification", {
                Title = "‚ùå Sai",
                Text = "Vui l√≤ng nh·∫≠p s·ªë ko ph·∫£i ch·ªØ!",
                Duration = 4
            })
        end
    end
end)

createToggle(mainPage, "esp ng∆∞·ªùi ch∆°i", espEnabled, function(state)
    espEnabled = state
    config.esp = state
    if autoSave then saveData(config) end
    if state then enableESP() else disableESP() end
end)

-- === Misc Page
createScriptButton(miscPage, "Infinite Yield", function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source"))()
end)

-- === Settings Page
createToggle(settingsPage, "T·ª± ƒë·ªông l∆∞u", autoSave, function(state)
    autoSave = state
    config.autoSave = state
    saveData(config)
end)

createScriptButton(settingsPage, "Xo√° Hack", function()
    disableESP()
    gui:Destroy()
end)

-- Toggle logic
local function updateToggle()
    frame.Visible = not frame.Visible
    toggleButton.BackgroundColor3 = frame.Visible and Color3.fromRGB(0,170,0) or Color3.fromRGB(170,0,0)
    toggleButton.Text = frame.Visible and "T·∫Øt" or "B·∫≠t"
end

toggleButton.MouseButton1Click:Connect(updateToggle)
UIS.InputBegan:Connect(function(i, gp)
    if i.KeyCode == Enum.KeyCode.RightControl and not gp then
        updateToggle()
    end
end)

updateToggle()

-- === Final Load State ===
if espEnabled then
    enableESP()
else
    disableESP()
end

StarterGui:SetCore("SendNotification", {
    Title = "Script Nh√† L√†m",
    Text = "T·∫°o b·ªüi c√°",
    Button1 = "Thank <3",
    Duration = 5
})
